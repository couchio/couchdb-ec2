#!/bin/sh

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Launch an EC2 CouchDB instance.

# Import variables
bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
. "$bin"/couchdb-ec2-env.sh

# Get the name for the AMI Image
AMI_INFO=`ec2-describe-images -a | grep $S3_BUCKET | grep $COUCHDB_VERSION | grep $ARCH | grep available`
AMI_IMAGE=`echo $AMI_INFO | awk '{print $2}'`

# TODO ebs support
# # EBS can be "new", an id, or blank. 
# EBS=new
# 
# # If it's blank don't use EBS.
# if [ ! -z $EBS ]; then
#   if [ "$EBS" == "new" ]; then
#     # create new ebs
#     # TODO support creating ebs from a snapshot
#     
#     # set EBS= new ebs id
#   fi
#   # attach ebs
# fi

# Start it
echo "Starting instance with AMI $AMI_IMAGE"
INSTANCE=`ec2-run-instances $AMI_IMAGE -n 1 -g $EC2_GROUP -k $EC2_KEY_NAME -t $INSTANCE_TYPE | grep INSTANCE | awk '{print $2}'`
echo "Waiting for instance $INSTANCE to start"
while true; do
  printf "."
  # get public dns
  HOSTNAME=`ec2-describe-instances $INSTANCE | grep running | awk '{print $4}'`
  if [ ! -z $HOSTNAME ]; then
    echo "Started as $HOSTNAME"
    break;
  fi
  sleep 1
done

echo "Access the CouchDB here:" 
echo "http://$HOSTNAME:5984/"
echo "or"
echo "http://$HOSTNAME/"
echo ""
echo "If your security-group '$GROUP' is open to the world, be sure to set a CouchDB Admin before someone else does. :)"
echo ""
echo "to setup an CouchDB admin run:"
echo "curl -v -X PUT http://$HOSTNAME:5984/_config/admins/username -d '\"password\"'"
echo ""
echo "to login to the ec2 instance run:"
echo ""
echo "ssh $SSH_OPTS \"$USER@$HOSTNAME\""
echo ""
echo "to terminate run:"
echo "ec2-terminate-instances $INSTANCE"
# echo ""
# echo "using EBS id: $EBS"