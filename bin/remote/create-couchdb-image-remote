#!/bin/sh

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Create a CouchDB AMI. Runs on the EC2 instance.

# Import variables
bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
. "$bin"/ec2-env-tmp.sh

# Remove environment script since it contains sensitive information
rm -f "$bin"/ec2-env-tmp.sh

# append our welcome message to the AMI message
echo "making motd"
cat /mnt/makeami/motd >> /etc/motd
cat /mnt/makeami/motd >> /etc/motd.tail

# updating things
echo "enabling the multiverse repository"
sed -i -e 's/universe/universe multiverse/g' /etc/apt/sources.list 

echo "updating and upgrading Ubuntu"
apt-get update -y
apt-get clean -y
apt-get upgrade -y

# install CouchDB (Can we use apt-get?)
echo "installing CouchDB and Apache2 with apt-get"
apt-get install -y couchdb apache2 ec2-api-tools ec2-ami-tools

echo "using /mnt/couchdb for data and logs"
mkdir -p /mnt/couchdb/data
mkdir -p /mnt/couchdb/logs
chown -R couchdb /mnt/couchdb
chmod -R 0770 /mnt/couchdb
# TODO configure logrotate for this logfile

COUCH_LOCAL_INI=/etc/couchdb/local.ini
# COUCH_LOCAL_INI=/usr/local/etc/couchdb/local.ini

echo "configuring CouchDB"
cat /mnt/makeami/couchdb-config.ini >> $COUCH_LOCAL_INI

# Configure Apache
echo "configure Apache"

mv /etc/apache2/mods-available/proxy* /etc/apache2/mods-enabled/
mv /etc/apache2/mods-available/rewrite.load /etc/apache2/mods-enabled/

# install the couchdb site
rm /etc/apache2/sites-enabled/*
mv /mnt/makeami/couchdb_vhost.conf /etc/apache2/sites-enabled/

# Do configuration on instance startup
mv /mnt/makeami/couchdb-init /usr/local/etc/couchdb-init
echo "/usr/local/etc/couchdb-init" >> /etc/init.d/rc.local 

# Delete SSH authorized_keys since it includes the key it was launched with. (Note that it is re-populated when an instance starts.)
rm -f /home/$USER/.ssh/authorized_keys

# Ensure logging in to new hosts is seamless.
echo '    StrictHostKeyChecking no' >> /etc/ssh/ssh_config

# echo "skipping bundle"
# exit 0

# Register image
echo "bundling image"
# Bundle and upload image
cd ~
# Don't need to delete .bash_history since it isn't written until exit.
df -h
ec2-bundle-vol -d /mnt -k /mnt/makeami/pk*.pem -c /mnt/makeami/cert*.pem -u $AWS_ACCOUNT_ID -s 3072 -p couchdb-$COUCHDB_VERSION-$ARCH -r $ARCH

ec2-upload-bundle -b $S3_BUCKET -m /mnt/couchdb-$COUCHDB_VERSION-$ARCH.manifest.xml -a $AWS_ACCESS_KEY_ID -s $AWS_SECRET_ACCESS_KEY

# End
echo "EC2 setup Done"
